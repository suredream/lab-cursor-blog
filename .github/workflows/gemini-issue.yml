name: Gemini Issue Maintainer

on:
  issue_comment:
    types: [created]
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  gemini_issue_handler:
    # 只处理包含 '/gemini' 的评论
    if: >
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '/gemini')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Gemini CLI via official Action
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are an autonomous code-maintenance agent for this Astro blog repository.

            The triggering GitHub issue comment is:
            ---
            ${{ github.event.comment.body }}
            ---

            Instructions:
            1. Extract the content of the comment that follows the first '/gemini' token.
            2. Interpret that as the user's main request.
            3. Plan the minimal set of code or content changes required to satisfy it.
            4. Use Gemini CLI tools (e.g., WriteFile, ApplyPatch) to:
               - Add or edit Markdown posts under src/pages/posts/.
               - Update src/pages/index.astro and layouts/BlogLayout.astro as needed.
            5. Keep the site simple and ensure that 'npm run build' will still succeed.
            6. When you are done, ensure all changes are written to disk and produce
               a concise summary of the modifications you made.

          settings: |
            {
              "model": "gemini-1.5-pro",
              "temperature": 0.3
            }

      - name: Commit and push changes (if any)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git status
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: apply Gemini changes for issue #${{ github.event.issue.number }}"
            git push
          else
            echo "No changes from Gemini."
          fi

      - name: Reply to issue with summary
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GEMINI_SUMMARY: ${{ steps.gemini.outputs.summary }}
        run: |
          SUMMARY="${GEMINI_SUMMARY:-Gemini CLI run completed. No summary provided.}"

          gh api \
            repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER}/comments \
            -f body="Gemini CLI run finished.\n\nSummary:\n\n${SUMMARY}"
