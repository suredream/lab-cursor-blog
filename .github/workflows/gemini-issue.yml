name: Gemini Issue Maintainer

on:
  issue_comment:
    types: [created]
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  gemini_issue_handler:
    runs-on: ubuntu-latest
    # 只处理包含 /gemini 的评论
    if: contains(github.event.comment.body, '/gemini')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Gemini CLI via official Action
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_debug: true

          # 关键：写一份项目级 settings.json，关掉会乱跑 shell 的东西
          settings: |
            {
              "output": {
                "format": "text"
              },
              "experimental": {
                "codebaseInvestigatorSettings": {
                  "enabled": false
                }
              },
              "tools": {
                "autoAccept": true,
                "shell": {
                  "enableInteractiveShell": false,
                  "showColor": false
                }
              }
            }

          # 让它只专注于改 Astro 博客相关文件，不要自己发明测试命令
          prompt: |
            You are an autonomous code-maintenance agent for this Astro blog repository.

            The triggering GitHub issue comment is:
            ---
            ${{ github.event.comment.body }}
            ---

            Instructions:
            1. Treat everything after the first '/gemini' token as the user's main request.
            2. Do NOT attempt to run shell commands or start dev servers.
            3. Only use file-oriented tools (read/modify/write/apply patches) on this repo.
            4. Typical operations:
               - Add/edit Markdown posts under src/pages/posts/
               - Adjust src/pages/index.astro
               - Adjust src/layouts/BlogLayout.astro
            5. Make the minimal set of changes required to satisfy the request.
            6. Ensure the project will still pass 'npm run build' for Astro.
            7. When finished, write all modified files to disk and output a concise summary.

      - name: Show Gemini CLI error (if any)
        if: failure() || steps.gemini.outputs.error != ''
        run: |
          echo "Gemini CLI reported error (if any):"
          echo '${{ steps.gemini.outputs.error }}'

      - name: Commit and push changes (if any)
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git status
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: apply Gemini changes for issue #${{ github.event.issue.number }}"
            git push
          else
            echo "No changes from Gemini."
          fi

      - name: Reply to issue with summary
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GEMINI_SUMMARY: ${{ steps.gemini.outputs.summary }}
        run: |
          SUMMARY="${GEMINI_SUMMARY:-Gemini CLI run completed. No summary provided.}"

          gh api \
            repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER}/comments \
            -f body="Gemini CLI run finished.\n\nSummary:\n\n${SUMMARY}"
